<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— å°½å¾é€” - èœ¿èœ’åœ°å›¾ç‰ˆ</title>
    <style>
        :root {
            --sky-top: #81ecec;
            --sky-btm: #74b9ff;
            --ground: #636e72;
            --tile-w: 80px;
            --map-node-size: 60px;
        }

        body {
            margin: 0; padding: 0;
            background: linear-gradient(to bottom, var(--sky-top), var(--sky-btm));
            color: #2d3436;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- é¡¶éƒ¨æ  --- */
        .top-bar {
            padding: 0 20px; height: 60px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.4); backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10;
        }
        .stats { font-weight: bold; color: #2d3436; }
        .stats span { color: #d63031; font-size: 1.2em; font-family: monospace; }
        
        .btn-top {
            background: #6c5ce7; color: white; padding: 6px 15px; border-radius: 20px;
            cursor: pointer; font-size: 12px; border: none; margin-left: 10px;
            transition: transform 0.1s;
        }
        .btn-top:active { transform: scale(0.95); }

        .map-icon {
            width: 36px; height: 36px; background: #fdcb6e; border-radius: 50%;
            border: 2px solid white; display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer; box-shadow: 0 4px 0 #e1b12c;
            transition: transform 0.1s;
        }
        .map-icon:active { transform: translateY(4px); box-shadow: none; }

        /* --- ä¸»èˆå° (è·‘é…·è§†å›¾) --- */
        .main-stage {
            flex: 1; position: relative; overflow: hidden;
        }

        .track-container {
            display: flex; height: 100%; padding-left: 50vw;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform; align-items: flex-end;
        }

        .level-unit {
            width: var(--tile-w); height: 100%; margin-right: 2px; flex-shrink: 0;
            position: relative; display: flex; flex-direction: column; justify-content: flex-end;
        }

        /* åœ°é¢ */
        .ground-block {
            height: 60px; background: var(--ground);
            border-top: 6px solid #55efc4;
            position: relative; display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: rgba(255,255,255,0.5);
        }
        .ground-block::after {
            content: ''; position: absolute; width: 100%; height: 100%;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.1) 10px, rgba(0,0,0,0.1) 20px);
        }

        /* å¤©ç©ºå¥–åŠ± */
        .sky-reward {
            position: absolute; bottom: 160px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
            font-size: 32px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
            animation: float 2s infinite ease-in-out; transition: all 0.3s;
        }
        .sky-reward.collected {
            opacity: 0.3; filter: grayscale(1); transform: scale(0.8) translateX(-60%); animation: none;
        }
        @keyframes float { 0%,100%{transform:translateY(0) translateX(-50%);} 50%{transform:translateY(-10px) translateX(-50%);} }

        /* ç©å®¶ */
        .player {
            position: absolute; left: 50vw; bottom: 65px; margin-left: -25px;
            width: 50px; height: 70px;
            background: url('https://api.iconify.design/noto:person-running.svg') no-repeat bottom center/contain;
            z-index: 50; transition: transform 0.1s; filter: drop-shadow(2px 4px 5px rgba(0,0,0,0.3));
        }
        .player.run { animation: run-bob 0.2s infinite alternate; }
        @keyframes run-bob { from{transform:translateY(0);} to{transform:translateY(-3px);} }

        /* --- åº•éƒ¨æ§åˆ¶æ  --- */
        .dock {
            height: 140px; background: #fff; border-top: 4px solid #dfe6e9;
            display: flex; padding: 0 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            position: relative; z-index: 60;
        }

        /* èƒŒåŒ…åŒº */
        .dock-left {
            flex: 1.2; display: flex; flex-direction: column; justify-content: center;
            border-right: 1px solid #dfe6e9; padding-right: 10px; margin-right: 10px;
        }
        .bag-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .bag-scroll {
            height: 60px; background: #f1f2f6; border-radius: 8px; border: 2px inset #dfe6e9;
            display: flex; align-items: center; gap: 5px; padding: 0 5px; overflow-x: auto;
        }
        .bag-item {
            width: 40px; height: 40px; background: white; border-radius: 5px; border: 1px solid #ced6e0;
            display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;
            animation: pop 0.3s;
        }
        @keyframes pop { from{transform:scale(0);} to{transform:scale(1);} }

        .btn-claim {
            background: #00b894; color: white; border: none; padding: 4px 10px; border-radius: 12px;
            font-size: 12px; cursor: pointer; box-shadow: 0 3px 0 #008f72;
        }
        .btn-claim:active { transform: translateY(3px); box-shadow: none; }
        .btn-claim:disabled { background: #b2bec3; box-shadow: none; cursor: default; transform: none;}

        /* æ§åˆ¶åŒº */
        .dock-right { flex: 1; display: flex; align-items: center; justify-content: space-around; }
        
        .dice-btn {
            width: 80px; height: 50px; border: none; border-radius: 10px; color: white; font-weight: bold;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .dice-btn:active { transform: translateY(4px); box-shadow: none; }
        .dice-btn:disabled { filter: grayscale(1); cursor: not-allowed; }
        
        .btn-blue { background: #0984e3; }
        .btn-pink { background: #e84393; }

        .dice-val {
            width: 50px; height: 50px; background: #2d3436; color: white; border-radius: 8px;
            font-size: 24px; font-weight: bold; display: flex; align-items: center; justify-content: center;
        }

        /* --- åœ°å›¾å¼¹çª— (å‚è€ƒå›¾ç‰‡å¸ƒå±€) --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            justify-content: center; align-items: center;
        }
        .modal-box {
            width: 95%; height: 70%; background: #fdf5e6; border-radius: 15px; /* ç±³é»„è‰²èƒŒæ™¯ä»¿çº¸è´¨ */
            display: flex; flex-direction: column; border: 4px solid #d4a373;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }
        
        .map-header {
            padding: 10px 15px; background: #d4a373; color: white; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }

        .map-scroll-view {
            flex: 1; overflow-x: auto; overflow-y: hidden;
            position: relative; 
            /* æ²™æ¼ /çº¸è´¨çº¹ç†èƒŒæ™¯ */
            background-image: radial-gradient(#e0c39e 10%, transparent 11%);
            background-size: 20px 20px;
            background-color: #fae3c6;
        }

        /* æ ¸å¿ƒï¼šç»å¯¹å®šä½çš„èœ¿èœ’åœ°å›¾å®¹å™¨ */
        .map-canvas {
            position: relative;
            height: 100%;
            /* å®½åº¦ç”± JS æ ¹æ®å…³å¡æ•°é‡åŠ¨æ€è®¡ç®— */
        }

        /* SVG çº¿æ¡å±‚ */
        .map-lines-svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
        }

        /* èŠ‚ç‚¹ */
        .map-node {
            position: absolute; width: 60px; height: 60px;
            background: #2d3436; border: 3px solid #636e72; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2; box-shadow: 0 5px 10px rgba(0,0,0,0.2);
            font-size: 10px; color: white; font-weight: bold;
            transition: transform 0.2s;
        }
        
        .map-node.reward-node { background: #6c5ce7; border-color: #a29bfe; }
        .map-node.coin-node { background: #0984e3; border-color: #74b9ff; }
        
        .node-icon { font-size: 24px; margin-bottom: -4px; }
        
        /* å½“å‰ä½ç½®æŒ‡ç¤ºå™¨ */
        .player-indicator {
            position: absolute; width: 40px; height: 50px; z-index: 10;
            background: url('https://api.iconify.design/noto:person-running.svg') no-repeat center/contain;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5));
            transition: all 0.5s ease;
            top: 0; left: 0; /* JSæ§åˆ¶ */
        }
        /* ç©å®¶å¤´åƒä¸‹çš„å°ç®­å¤´ */
        .player-indicator::after {
            content: 'â–¼'; position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%);
            color: #d63031; font-size: 14px; animation: bounce 1s infinite;
        }
        @keyframes bounce { 0%,100%{transform:translate(-50%, 0);} 50%{transform:translate(-50%, 5px);} }

        /* ä¸‡èƒ½éª°å­é€‰æ‹©å™¨ */
        .magic-modal {
            background: white; padding: 20px; border-radius: 10px; text-align: center;
            max-width: 300px;
        }
        .grid-6 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .num-btn { padding: 15px; background: #eee; border: none; font-size: 18px; border-radius: 8px; cursor: pointer; }
        .num-btn:hover { background: #e84393; color: white; }

        .rank-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        .rank-table td { padding: 8px; border-bottom: 1px solid #eee; }

    </style>
</head>
<body>

    <div class="top-bar">
        <div class="stats">å½“å‰ä½ç½®: <span id="pos-display">1</span></div>
        <div style="display:flex; align-items:center;">
            <button class="btn-top" onclick="openModal('rank')">ğŸ† æ’è¡Œæ¦œ</button>
            <div style="margin-left:15px; text-align:center;" onclick="openMap()">
                <div class="map-icon">ğŸ—ºï¸</div>
                <div style="font-size:10px; font-weight:bold; margin-top:2px;">å…¨æ™¯åœ°å›¾</div>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ï¼šè·‘é…· -->
    <div class="main-stage">
        <div class="track-container" id="track"></div>
        <div class="player" id="player"></div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶ -->
    <div class="dock">
        <!-- èƒŒåŒ… -->
        <div class="dock-left">
            <div class="bag-header">
                <span style="font-size:12px; font-weight:bold; color:#636e72;">ğŸ’ èƒŒåŒ…</span>
                <button class="btn-claim" id="btn-claim" onclick="claimAll()" disabled>ä¸€é”®é¢†å–</button>
            </div>
            <div class="bag-scroll" id="bag-container">
                <span style="font-size:11px; color:#b2bec3; width:100%; text-align:center;">ç©ºç©ºå¦‚ä¹Ÿ</span>
            </div>
        </div>

        <!-- éª°å­ -->
        <div class="dock-right">
            <button class="dice-btn btn-normal" onclick="rollDice()" id="btn-normal">
                <span style="font-size:20px">ğŸ²</span>
                <span style="font-size:10px">æ— é™æ¬¡æ•°</span>
            </button>

            <div class="dice-val" id="dice-val">?</div>

            <button class="dice-btn btn-pink" onclick="openModal('magic')" id="btn-magic">
                <span style="font-size:20px">âœ¨</span>
                <span style="font-size:10px">å‰©: <span id="magic-count">3</span></span>
            </button>
        </div>
    </div>

    <!-- åœ°å›¾å¼¹çª— -->
    <div class="modal" id="modal-map">
        <div class="modal-box">
            <div class="map-header">
                <span>ğŸ—ºï¸ å†’é™©åœ°å›¾</span>
                <button onclick="closeModal('map')" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">Ã—</button>
            </div>
            <div class="map-scroll-view" id="map-scroll-view">
                <div class="map-canvas" id="map-canvas">
                    <!-- SVG çº¿æ¡ -->
                    <svg class="map-lines-svg" id="map-lines"></svg>
                    <!-- ç©å®¶æŒ‡ç¤ºå™¨ -->
                    <div class="player-indicator" id="map-player"></div>
                    <!-- èŠ‚ç‚¹å°†ç”± JS æ’å…¥ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸‡èƒ½éª°å­å¼¹çª— -->
    <div class="modal" id="modal-magic">
        <div class="magic-modal">
            <h3>é€‰æ‹©æ­¥æ•°</h3>
            <div class="grid-6">
                <button class="num-btn" onclick="useMagic(1)">1</button>
                <button class="num-btn" onclick="useMagic(2)">2</button>
                <button class="num-btn" onclick="useMagic(3)">3</button>
                <button class="num-btn" onclick="useMagic(4)">4</button>
                <button class="num-btn" onclick="useMagic(5)">5</button>
                <button class="num-btn" onclick="useMagic(6)">6</button>
            </div>
            <button onclick="closeModal('magic')" style="margin-top:15px; background:none; border:none; cursor:pointer; color:#999;">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œå¼¹çª— -->
    <div class="modal" id="modal-rank">
        <div class="magic-modal" style="width:300px;">
            <div style="display:flex; justify-content:space-between;">
                <h3>ğŸ† æ’è¡Œæ¦œ</h3>
                <button onclick="closeModal('rank')" style="border:none;background:none;font-size:20px;">Ã—</button>
            </div>
            <table class="rank-table" id="rank-table"></table>
        </div>
    </div>

    <script>
        const TOTAL_TILES = 100; // ç¤ºä¾‹å…³å¡æ•°
        const TILE_W = 82; 
        
        let state = {
            pos: 0,
            magic: 3,
            isMoving: false,
            data: [],
            bag: []
        };

        const trackEl = document.getElementById('track');
        const playerEl = document.getElementById('player');
        
        function init() {
            // ç”Ÿæˆæ•°æ®
            for(let i=0; i<TOTAL_TILES; i++) {
                let r = null;
                if(i===TOTAL_TILES-1) r='ğŸ†';
                else if(i>0) {
                    let rand = Math.random();
                    if(rand>0.9) r='ğŸ';
                    else if(rand>0.8) r='ğŸª™';
                    else if(rand>0.7) r='ğŸ§ª';
                }
                state.data.push({id:i, reward:r});
            }

            // æ¸²æŸ“è·‘é“
            let html = '';
            state.data.forEach(d => {
                let sky = d.reward ? `<div class="sky-reward" id="reward-${d.id}">${d.reward}</div>` : '';
                html += `
                    <div class="level-unit">
                        ${sky}
                        <div class="ground-block">${d.id+1}</div>
                    </div>`;
            });
            trackEl.innerHTML = html;

            updateUI();
        }

        function updateUI() {
            const offset = -(state.pos * TILE_W);
            trackEl.style.transform = `translateX(${offset}px)`;
            document.getElementById('pos-display').innerText = state.pos + 1;
            document.getElementById('magic-count').innerText = state.magic;
        }

        async function move(steps) {
            if(state.isMoving) return;
            state.isMoving = true;
            document.getElementById('btn-normal').disabled = true;
            document.getElementById('btn-magic').disabled = true;

            playerEl.classList.add('run');

            for(let i=0; i<steps; i++) {
                if(state.pos >= TOTAL_TILES-1) break;
                state.pos++;
                updateUI();
                
                // æ”¶é›†
                let d = state.data[state.pos];
                if(d.reward) {
                    let el = document.getElementById(`reward-${d.id}`);
                    if(el && !el.classList.contains('collected')) {
                        el.classList.add('collected');
                        addToBag(d.reward);
                    }
                }
                await new Promise(r => setTimeout(r, 300));
            }

            playerEl.classList.remove('run');
            state.isMoving = false;
            document.getElementById('btn-normal').disabled = false;
            if(state.magic > 0) document.getElementById('btn-magic').disabled = false;
        }

        // --- åœ°å›¾æ¸²æŸ“ (æ ¸å¿ƒï¼šèœ¿èœ’æ›²çº¿) ---
        function renderMap() {
            const canvas = document.getElementById('map-canvas');
            const svg = document.getElementById('map-lines');
            // æ¸…ç†æ—§èŠ‚ç‚¹ (é™¤äº†SVGå’ŒPlayer)
            Array.from(canvas.querySelectorAll('.map-node')).forEach(el => el.remove());

            // å¸ƒå±€å‚æ•°
            const nodeW = 60, nodeH = 60;
            const xStep = 120; // æ¨ªå‘é—´è·
            const yBase = 150; // åŸºç¡€é«˜åº¦
            const yAmp = 80;   // æ³¢æµªå¹…åº¦

            // è®¾ç½®ç”»å¸ƒæ€»å®½
            const totalW = (TOTAL_TILES * xStep) + 100;
            canvas.style.width = totalW + 'px';

            let points = [];
            let pathD = "";

            state.data.forEach((d, i) => {
                // è®¡ç®—èœ¿èœ’åæ ‡ (Sine Wave)
                // x çº¿æ€§å¢åŠ 
                // y ä½¿ç”¨ sin å‡½æ•°äº§ç”Ÿæ³¢æµªï¼Œi*0.5 æ§åˆ¶æ³¢æµªé¢‘ç‡
                let x = 50 + (i * xStep);
                let y = yBase + Math.sin(i * 0.8) * yAmp;

                points.push({x, y});

                // åˆ›å»ºèŠ‚ç‚¹ DOM
                let div = document.createElement('div');
                div.className = 'map-node';
                if(d.reward) {
                    div.classList.add(d.reward === 'ğŸª™' ? 'coin-node' : 'reward-node');
                }
                div.style.left = (x - nodeW/2) + 'px';
                div.style.top = (y - nodeH/2) + 'px';
                
                let icon = d.reward ? `<div class="node-icon">${d.reward}</div>` : '';
                div.innerHTML = `${icon}<div>${d.id+1}</div>`;
                
                // å¦‚æœæ˜¯å½“å‰ä½ç½®ï¼Œç§»åŠ¨æŒ‡ç¤ºå™¨
                if(d.id === state.pos) {
                    const indicator = document.getElementById('map-player');
                    indicator.style.left = (x - 20) + 'px'; // 20æ˜¯å®½åº¦çš„ä¸€åŠ
                    indicator.style.top = (y - 70) + 'px'; // æ‚¬æµ®åœ¨èŠ‚ç‚¹ä¸Šæ–¹
                }

                canvas.appendChild(div);
            });

            // ç”Ÿæˆè´å¡å°”æ›²çº¿è·¯å¾„
            // ç®€å•èµ·è§ï¼Œç”¨ç›´çº¿è¿æ¥ï¼Œæˆ–è€…ç®€å•çš„ä¸‰æ¬¡è´å¡å°”
            if(points.length > 1) {
                pathD = `M ${points[0].x} ${points[0].y}`;
                for(let i=1; i<points.length; i++) {
                    let p1 = points[i-1];
                    let p2 = points[i];
                    // æ§åˆ¶ç‚¹ï¼šå½¢æˆSæ›²çº¿
                    let cp1x = p1.x + (p2.x - p1.x) / 2;
                    let cp1y = p1.y;
                    let cp2x = p1.x + (p2.x - p1.x) / 2;
                    let cp2y = p2.y;
                    
                    pathD += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2.x} ${p2.y}`;
                }
            }

            svg.innerHTML = `<path d="${pathD}" stroke="#b78e63" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="15,10" />`;
        }

        function openMap() {
            renderMap();
            document.getElementById('modal-map').style.display = 'flex';
            // æ»šåŠ¨åˆ°å½“å‰ä½ç½®
            setTimeout(() => {
                const scroll = document.getElementById('map-scroll-view');
                // ä¼°ç®—æ»šåŠ¨ä½ç½®
                const targetX = (state.pos * 120) - (scroll.clientWidth / 2);
                scroll.scrollTo({left: targetX, behavior: 'smooth'});
            }, 100);
        }

        // --- èƒŒåŒ… ---
        function addToBag(item) {
            state.bag.push(item);
            renderBag();
        }
        function renderBag() {
            const el = document.getElementById('bag-container');
            const btn = document.getElementById('btn-claim');
            if(state.bag.length === 0) {
                el.innerHTML = '<span style="font-size:11px;color:#b2bec3;width:100%;text-align:center">èƒŒåŒ…ç©ºç©º</span>';
                btn.disabled = true;
                return;
            }
            let html = '';
            state.bag.forEach(i => html += `<div class="bag-item">${i}</div>`);
            el.innerHTML = html;
            el.scrollLeft = el.scrollWidth;
            btn.disabled = false;
        }
        function claimAll() {
            alert(`é¢†å–äº†: ${state.bag.join(' ')}`);
            state.bag = [];
            renderBag();
        }

        // --- éª°å­ä¸å¼¹çª— ---
        function rollDice() {
            let val = Math.floor(Math.random()*6)+1;
            document.getElementById('dice-val').innerText = val;
            move(val);
        }
        function useMagic(v) {
            if(state.magic<=0) return;
            state.magic--;
            document.getElementById('dice-val').innerText = v;
            closeModal('magic');
            move(v);
        }
        function openModal(id) {
            if(id==='rank') renderRank();
            document.getElementById('modal-'+id).style.display = 'flex';
        }
        function closeModal(id) { document.getElementById('modal-'+id).style.display = 'none'; }
        
        function renderRank() {
            document.getElementById('rank-table').innerHTML = `
                <tr><td>1</td><td>é©¬é‡Œå¥¥</td><td>999æ­¥</td></tr>
                <tr><td>2</td><td>è·¯æ˜“åŸº</td><td>888æ­¥</td></tr>
                <tr style="color:#6c5ce7;font-weight:bold"><td>3</td><td>æˆ‘</td><td>${state.pos}æ­¥</td></tr>`;
        }

        init();
    </script>
</body>
</html>